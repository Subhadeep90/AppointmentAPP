<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Expense</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</head>
<style>
h4{
    color:red
}
</style>
<body>
<form>
 Choose Expenditure:<input type="number" id="amount">
 Choose Description:<input type="text" id="Description">
 Choose a Category:<select id="category">
     <option>Fuel</option>
     <option>Food</option>
     <option>Electricity</option>
     <option>Movie</option>
 </select>
 <button type="submit" id="submitbutton">Add Expense</button>
</form>
<ul id="ListOftems"></ul>
<button type="submit"id="razorpay">Buy Premium Membership</ul>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<h4 id="h4"></h4>


</body>
<script>
 const submitbutton=document.getElementById('submitbutton')
 submitbutton.addEventListener('click',additems)
 function additems(e)
 {
     e.preventDefault()
    const obj={
      Expenditure:document.getElementById('amount').value,
      Description:document.getElementById('Description').value,
      Category:document.getElementById('category').value
     }
     const token=localStorage.getItem('token')
     axios.post("http://localhost:3000/user/expense/addexpense",obj,{headers:{"Authentication":token}})
     .then((result)=>{
       showOnscreen(result.data.result)

     })
     .catch((error)=>{
         console.log(error)
     })
 }
 function showOnscreen(obj)
 {
   const ListOftems=document.getElementById('ListOftems')
   const li=document.createElement('li')
   li.append(obj.Expenditure,"----",obj.Description,"----",obj.Category)
   const deletebutton=document.createElement('button')
   deletebutton.innerText="Delete"; 
   deletebutton.onclick=(e)=>{
   deleteitems(obj)
   const litoremove=e.target.parentElement
   ListOftems.removeChild(litoremove);
   }
   
   li.append(deletebutton);
   ListOftems.append(li);
 }
 window.addEventListener('DOMContentLoaded',fetchDetails)
 function fetchDetails()
 {
     const token=localStorage.getItem('token')
    axios.get("http://localhost:3000/user/expense/getexpense",{headers:{"Authentication":token}})
     .then((result)=>{
         for(var i=0;i<result.data.result.length;i++)
         {   

             showOnscreen(result.data.result[i])
         }
     })
     .catch((error)=>{
         console.log(error)
     })
 }

 function deleteitems(obj)
 {
    const token=localStorage.getItem('token')
    axios.delete(`http://localhost:3000/user/expense/deleteexpense/${obj.id}`,{headers:{"Authentication":token}})
     .then((result)=>{
      console.log(result)
 })
 .catch((error)=>{
     console.log(error.response.data.message)
     const h4=document.getElementById('h4')
     h4.append(error.response.data.message);
     setTimeout(()=>{
         h4.remove()
     },2000)
 })
     
 }
 const razorpay=document.getElementById('razorpay')
 razorpay.addEventListener('click',buypremium)
 function buypremium(e)
 {
    e.preventDefault()
    const token=localStorage.getItem('token') 
    axios.get("http://localhost:3000/user/buypremium",{headers:{"Authentication":token}})
    .then((result)=>{
        let options={
            "key":result.data.key_id,
            "order_id":result.data.order.id,
            "handler":async function(result)
            {
                alert('You are a Premium User Now');
                await axios.post("http://localhost:3000/purchase/updatetransactionstatus",{
                order_id:options.order_id,
                payment_id:result.razorpay_payment_id,
                },{headers:{"Authorization":token}})

            },

        };
        const razorpay=new Razorpay(options);
        razorpay.open();
        
        razorpay.on('payment.failed',function(result){
            console.log(result.error)
            axios.post("http://localhost:3000/purchase/updatetransactionstatus",{
                order_id:result.error.metadata.order_id,
                payment_id:result.error.metadata.payment_id,
                error:result.error.reason,
            },{
                headers:{"Authorization":token}
            
            })
            alert('Something went wrong')
            
    }
        ) 
        
    })
    .catch((error)=>{
        console.log(error)
    })
 }
</script>
</html>